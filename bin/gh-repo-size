#!/usr/bin/env bash
set -eufo pipefail

# https://en.wikipedia.org/wiki/Binary_prefix
readonly units='KMGTPEZYRQ'

# https://mywiki.wooledge.org/BashProgramming/05#Arithmetic_Expansion
is_uint() {
	printf %d "$1" &>/dev/null && [[ $1 -ge 0 ]]
}

for r in "$@"; do
	# trim spaces and "/", for better UX
	r="${r#"${r%%[!/[:space:]]*}"}"
	r="${r%"${r##*[!/[:space:]]}"}"

	if ! kilobytes="$(gh api "repos/$r" --jq .size --cache 1h)";
	then
		printf 'error\t%s\n' "$r"
		continue
	fi

	if ! is_uint "$kilobytes"; then
		printf %s "assertion failed: size must be unsigned integer, but got $kilobytes" 1>&2
		exit 128
	fi
	# TO-DO: handle exponential notation

	len="${#kilobytes}"

	if [[ $len -eq 0 ]]; then
		echo 'assertion failed: empty numeral' 1>&2
		exit 128
	fi

	i="$(((len - 1) / 3))"
	len="$(((len - 1) % 3 + 1))"

	# formatted like `du -h`, for `sort -h`
	printf "${kilobytes::len}${units:i:1}\t%s\n" "$r"
done
